<!---------------------- MAIN CONTENT -------------------------------------------------->
<h5 style="margin: 0px; padding: 0px;" class="center">Prescrever medicamento</h5>
<hr>
<main id="mainContent">

  <!-- CONTE√öDO PRINCIPAL -->
  <div id="conteudoPrincipal">
    <!-- LAYOUT HORIZONTAL (LADO A LADO) -->
    <div class="row">
      <!-- PARTE 1: SUGEST√ÉO DA IA (ESQUERDA - 50%) -->
      <div class="col s12 l6">
        <div class="box" style="position: relative; min-height: 300px;">
          <h6><i class='bx bx-brain'></i> Sugest√£o da IA</h6>
          <div id="resultadoIA" style="max-height: 500px; overflow-y: auto;">
            <em>Preencha os dados do paciente e clique em "Analisar" para receber uma sugest√£o da IA...</em>
          </div>
          <div class="loading-overlay" id="loadingIA">
            <div class="preloader-wrapper big active">
              <div class="spinner-layer spinner-blue-only">
                <div class="circle-clipper left">
                  <div class="circle"></div>
                </div>
                <div class="gap-patch">
                  <div class="circle"></div>
                </div>
                <div class="circle-clipper right">
                  <div class="circle"></div>
                </div>
              </div>
            </div>
            <p>Analisando dados com IA...</p>
          </div>
        </div>

        <!-- CAMPO DE PROMPT ADICIONAL -->
        <div class="box" style="margin-top: 15px;">
          <h6><i class='bx bx-message-square-edit'></i> Prompt Adicional</h6>

          <form action="" id="addSugestaoMedica">
            <div class="input-field" style="margin-top: 15px;">
              <textarea name="adicional" id="promptAdicional" class="materialize-textarea"
                placeholder="Ex: Considerar hist√≥rico de diabetes, focar em medicamentos gen√©ricos, evitar anti-inflamat√≥rios..."></textarea>
              <label for="promptAdicional">Instru√ß√µes extras para a IA (opcional)</label>
            </div>

            <button type="submit" class="btn waves-effect teal font-normal" id="btnRefazer">
              <i class='bx bx-refresh'></i> Refazer an√°lise
            </button>

          </form>

        </div>
      </div>

      <!-- PARTE 2: TABS (DIREITA - 50%) -->
      <div class="col s12 l6">
        <!-- TABS HEADER -->
        <div class="custom-tabs">
          <button class="custom-tab active" onclick="switchTab('tabDadosPaciente')" id="btnTabDados">
            <i class='bx bx-user-circle'></i> Dados do Paciente
          </button>
          <button class="custom-tab" onclick="switchTab('tabMedicamentos')" id="btnTabMedicamentos">
            <i class='bx bx-plus-medical'></i> Adicionar Medicamento
          </button>
          <button class="custom-tab" onclick="switchTab('tabObservacoes')" id="btnTabObservacoes">
            <i class='bx bx-note'></i> Observa√ß√µes
          </button>
        </div>

        <!-- TABS CONTENT -->
        <div class="tab-content-wrapper">

          <!-- TAB 1: DADOS DO PACIENTE -->
          <div id="tabDadosPaciente" class="tab-panel active">

            <form action="" id="formPaciente"> <!-- inicio do fim do form  paciente -->
              <!-- nome idade peso -->
              <div class="row">
                <div class="input-field col s12 m6">
                  <input type="text" name="nome" id="nomePaciente" value="{{nome}}" required>
                  <label for="nomePaciente">Nome do Paciente *</label>
                  <span class="error-message" id="errorNome">Campo obrigat√≥rio (m√≠nimo 3 caracteres)</span>
                </div>
                <div class="input-field col s12 m3">
                  <input type="number" name="idade" id="idadePaciente" value="{{idade}}" min="0" max="120" required>
                  <label for="idadePaciente">Idade *</label>
                  <span class="error-message" id="errorIdade">Idade inv√°lida (0-150)</span>
                </div>
                <div class="input-field col s12 m3">
                  <input type="number" name="peso" id="pesoPaciente" value="{{peso}}" min="1" max="300" step="0.1">
                  <label for="pesoPaciente">Peso (kg)</label>
                  <span class="error-message" id="errorPeso">Peso inv√°lido (1-300kg)</span>
                </div>
              </div>
              <!-- sintomas e diagnostico -->
              <div class="row">
                <div class="input-field col s12 m6">
                  <textarea id="sintomas" name="sintomas" class="materialize-textarea"
                    required>{{motivo_consulta}}</textarea>
                  <label for="sintomas">Sintomas Relatados *</label>
                  <span class="error-message" id="errorSintomas">Descreva os sintomas (m√≠nimo 5 caracteres)</span>
                </div>
                <div class="input-field col s12 m6">
                  <textarea id="diagnostico" name="diagnostico" class="materialize-textarea"
                    required>{{diagnostico}}</textarea>
                  <label for="diagnostico">Diagnostico *</label>
                  <span class="error-message" id="errorDiagnostico">Descreva os sintomas (m√≠nimo 5 caracteres)</span>
                </div>
              </div>
              <!-- alergia medicamento -->
              <div class="row">
                <div class="input-field col s12 m6">
                  <textarea id="alergias" name="alergia" class="materialize-textarea">{{alergia}}</textarea>
                  <label for="alergias">Alergias Conhecidas</label>
                </div>
                <div class="input-field col s12 m6">
                  <textarea id="medicamentosUso" name="usoMedicamento"
                    class="materialize-textarea">{{medicamentoUso}}</textarea>
                  <label for="medicamentosUso">Medicamentos em Uso</label>
                </div>
              </div>

              <div class="row">
                <div class="col s12">

                  <!-- <button type="submit" class="btn green waves-effect font-normal" onclick="gerarPrescricao()" -->
                  <button type="submit" class="btn green waves-effect font-normal" id="btnAnalisar">
                    <i class='bx bx-brain'></i> Analisar com IA
                  </button>

                  <button type="button" class="btn grey lighten-1" onclick="limparFormulario()">
                    <i class='bx bx-trash'></i> Limpar
                  </button>
                </div>
              </div>
            </form> <!-- fim do form dos dados do paciente-->

          </div>

          <form method="post" enctype="multipart/form-data">
            <!-- TAB 2: ADICIONAR MEDICAMENTOS -->
            <div id="tabMedicamentos" class="tab-panel">
              <div class="row">
                <div class="col s12">
                  <h6 style="color:#00695c;margin-bottom:20px;">
                    <i class='bx bx-plus-circle'></i> Adicionar Medicamentos
                  </h6>
                  <table class="responsive-table">
                    <thead>
                      <tr class="rows">
                        <th class="grey lighten-1 font-normal" style="height: 5px !important; ">Medicamento</th>
                        <th class="grey lighten-1 font-normal" style="border-left:2px solid white ; height: 5px !important; ">Via de
                          administra√ß√£o
                        </th>
                        <th class="grey lighten-1 font-normal" style="border-left:2px solid white ;height: 5px !important; ">Posologia</th>
                        <th class="grey lighten-1 font-normal" style="border-left:2px solid white ;height: 5px !important; ">A√ß√£o</th>
                      </tr>
                    </thead>
                    <tbody id="tabela-medicamento-body">
                      <tr class="row">
                        <td style="width: 38%;">
                          <select name="medicamentoNome[]">
                            <option value="" disabled selected>Selecione</option>
                            {{medicamentos}}
                          </select>
                        </td>
                        <td style="width: 29%;">
                          <select name="medicamentoVia[]">
                            <option value="" disabled selected>Selecione</option>
                            <option value="Oral">Oral</option>
                            <option value="Intravenosa">Intravenosa</option>
                            <option value="Intramuscular">Intramuscular</option>
                            <option value="T√≥pica">T√≥pica</option>
                            <option value="Subcut√¢nea">Subcut√¢nea</option>
                            <option value="Inalat√≥ria">Inalat√≥ria</option>
                          </select>
                        </td>
                        <td style="width: 33%;">
                          <input type="text" name="medicamentoPosologia[]" placeholder="Ex:1comprimido 3x/dia">
                        </td>
                        <td class="center">
                          <a class="btn red white-text" onclick="removerLinhaMedicamento(this)"
                            style="display: inline-flex; align-items: center; justify-content: center; height: 36px; width: 36px;">
                            <i class='bx bx-trash'></i>
                          </a>
                        </td>
                      </tr>
                    </tbody>
                  </table>

                  <div class="row center" style="margin-top:20px;">
                    <br>
                    <a class="tooltip-container btn teal" onclick="adicionarLinhaMedicamento()">
                      <i class='bx bx-plus'></i>
                      <div class="custom-tooltip font-normal ">Adicionar nova linha</div>
                    </a>
                  </div>
                </div>
              </div>

              <!-- BOT√ÉO SEGUINTE NO CANTO DIREITO -->
              <div class="row" style="margin-top:30px;padding-top:20px;border-top:2px solid #e0e0e0;">
                <div class="col s12" style="text-align: right;">
                  <button type="button" class="btn teal" onclick="avancarParaObservacoes()">
                    <i class='bx bx-chevron-right'></i> seguinte
                  </button>
                </div>
              </div>
            </div>

            <!-- TAB 3: OBSERVA√á√ïES -->
            <div id="tabObservacoes" class="tab-panel">
              <div class="row">
                <div class="input-field col s12">
                  <textarea id="prescricaoFinal" name="Obs" class="materialize-textarea" style="min-height: 250px;"></textarea>
                  <label for="prescricaoFinal">Observa√ß√µes da prescri√ß√£o </label>
                </div>
              </div>

              <div class="row">
                <div class="col s12">
                  <button type="submit" name="salvarPrescrisao" class="btn blue" id="btnSalvar">
                    <i class='bx bx-save'></i> Salvar Prescri√ß√£o
                  </button>
                  <button type="button" class="btn orange" onclick="copiarPrescricao()">
                    <i class='bx bx-copy'></i> Copiar
                  </button>
                </div>
              </div>
            </div>
          </form>

        </div>
      </div>

    </div>
  </div>

</main>

<!-- Materialize JS -->
<script src="{{URL}}/Assets/js/materialize.js"></script>

<script>

  var loading = document.getElementById('loadingIA');

  // Inicializar Materialize
  document.addEventListener('DOMContentLoaded', function () {
    M.updateTextFields();

    // Inicializar o drop menu
    var drop = document.querySelectorAll('.dropdown-trigger');
    var instances = M.Dropdown.init(drop, {
      coverTrigger: false,
      closeOnClick: false,
      constrainWidth: false,
      alignment: 'left',
      closeOnClick: false // mant√©m aberto enquanto navega

    });

    // Inicializar textareas individualmente
    document.querySelectorAll('.materialize-textarea').forEach(textarea => {
      M.textareaAutoResize(textarea);
    });

    // Inicializar selects
    M.FormSelect.init(document.querySelectorAll('select'));
  });

  // FUN√á√ÉO PARA TROCAR TABS
  function switchTab(tabId) {
    // Remover active de todos os tabs
    document.querySelectorAll('.custom-tab').forEach(tab => {
      tab.classList.remove('active');
    });

    document.querySelectorAll('.tab-panel').forEach(panel => {
      panel.classList.remove('active');
    });

    // Adicionar active no tab clicado
    if (tabId === 'tabDadosPaciente') {
      document.getElementById('btnTabDados').classList.add('active');
    } else if (tabId === 'tabMedicamentos') {
      document.getElementById('btnTabMedicamentos').classList.add('active');
    } else if (tabId === 'tabObservacoes') {
      document.getElementById('btnTabObservacoes').classList.add('active');
    }

    document.getElementById(tabId).classList.add('active');

    // Atualizar campos do Materialize
    M.updateTextFields();

    // Reinicializar textareas do Materialize individualmente
    document.querySelectorAll('.materialize-textarea').forEach(textarea => {
      M.textareaAutoResize(textarea);
    });

    // Reinicializar selects
    M.FormSelect.init(document.querySelectorAll('select'));
  }

  // CHAT CONTROLS
  const chatSidebar = document.getElementById('chatSidebar');
  const btnOpen = document.getElementById('btnOpenChat');
  const btnClose = document.getElementById('btnCloseChat');

  btnOpen.onclick = () => {
    chatSidebar.classList.add('open');
    btnOpen.style.display = 'none';
  };

  btnClose.onclick = () => {
    chatSidebar.classList.remove('open');
    btnOpen.style.display = 'flex';
  };

  // VALIDA√á√ïES
  function validarCampo(campo, errorId, validacao) {
    const input = document.getElementById(campo);
    const error = document.getElementById(errorId);
    const inputField = input.closest('.input-field');

    if (!validacao(input.value)) {
      inputField.classList.add('error');
      error.classList.add('show');
      return false;
    } else {
      inputField.classList.remove('error');
      error.classList.remove('show');
      return true;
    }
  }

  function validarFormulario() {
    let valido = true;

    valido &= validarCampo('nomePaciente', 'errorNome', (v) => v.trim().length >= 3);
    valido &= validarCampo('idadePaciente', 'errorIdade', (v) => {
      const idade = parseInt(v);
      return idade >= 0 && idade <= 150;
    });

    const peso = document.getElementById('pesoPaciente').value;
    if (peso) {
      valido &= validarCampo('pesoPaciente', 'errorPeso', (v) => {
        const p = parseFloat(v);
        return p > 0 && p <= 300;
      });
    }

    valido &= validarCampo('sintomas', 'errorSintomas', (v) => v.trim().length >= 5);
    valido &= validarCampo('diagnostico', 'errorDiagnostico', (v) => v.trim().length >= 5);

    return valido;
  }


  // COPIAR PRESCRI√á√ÉO
  function copiarPrescricao() {
    const prescricao = document.getElementById('prescricaoFinal').value;

    if (!prescricao.trim()) {
      M.toast({ html: '‚ö†Ô∏è Nenhum texto para copiar', classes: 'orange' });
      return;
    }

    navigator.clipboard.writeText(prescricao).then(() => {
      M.toast({ html: 'üìã Prescri√ß√£o copiada!', classes: 'green' });
    }).catch(() => {
      M.toast({ html: '‚ùå Erro ao copiar', classes: 'red' });
    });
  }

  // LIMPAR FORMUL√ÅRIO
  function limparFormulario() {
    document.getElementById('formPaciente').reset();
    document.getElementById('resultadoIA').innerHTML = '<em>Preencha os dados do paciente e clique em "Analisar"...</em>';
    document.getElementById('prescricaoFinal').value = '';

    // Remover erros
    document.querySelectorAll('.input-field.error').forEach(el => el.classList.remove('error'));
    document.querySelectorAll('.error-message.show').forEach(el => el.classList.remove('show'));

    M.updateTextFields();
    M.toast({ html: 'üóëÔ∏è Formul√°rio limpo', classes: 'blue-grey' });
  }


  // CHAT COM VALIDA√á√ÉO
  function sendMsg() {
    const input = document.getElementById('chatInput');
    const mensagem = input.value.trim();

    if (!mensagem) {
      M.toast({ html: '‚ö†Ô∏è Digite uma mensagem', classes: 'orange' });
      return;
    }

    const chatMessages = document.getElementById('chatMessages');
    chatMessages.innerHTML += `
        <div class="chat-message user">
          <strong>Voc√™:</strong> ${mensagem}
        </div>
      `;

    input.value = '';
    chatMessages.scrollTop = chatMessages.scrollHeight;

    // Simular resposta da IA
    setTimeout(() => {
      chatMessages.innerHTML += `
          <div class="chat-message system">
            <strong>Assistente:</strong> Entendi sua quest√£o sobre "${mensagem}". 
            Posso ajudar com informa√ß√µes m√©dicas gerais, dosagens e intera√ß√µes medicamentosas.
          </div>
        `;
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }, 1000);
  }

  // Enter no chat
  document.getElementById('chatInput').addEventListener('keypress', function (e) {
    if (e.key === 'Enter') {
      sendMsg();
    }
  });

  // FUN√á√ÉO ADICIONAR LINHA DE MEDICAMENTO
  function adicionarLinhaMedicamento() {
    const tabela = document.getElementById('tabela-medicamento-body');
    const linhaModelo = tabela.rows[0];
    const novaLinha = linhaModelo.cloneNode(true);

    // Substituir select-wrapper por selects novos
    const wrappersClonados = Array.from(novaLinha.querySelectorAll('.select-wrapper'));
    const selectsModelo = Array.from(linhaModelo.querySelectorAll('select'));

    wrappersClonados.forEach((wrapper, idx) => {
      const selectModelo = selectsModelo[idx];
      if (!selectModelo) {
        wrapper.remove();
        return;
      }

      const novoSelect = document.createElement('select');
      novoSelect.innerHTML = selectModelo.innerHTML;

      Array.from(selectModelo.attributes).forEach(attr => {
        if (attr.name.toLowerCase() !== 'id') {
          novoSelect.setAttribute(attr.name, attr.value);
        }
      });

      novoSelect.value = '';
      novoSelect.removeAttribute('id');

      wrapper.parentNode.replaceChild(novoSelect, wrapper);
    });


    // Limpar selects simples
    novaLinha.querySelectorAll('select').forEach(select => {
      select.value = '';
      select.classList.remove('initialized');
      select.removeAttribute('id');
    });

    // Limpar inputs e remover IDs
    novaLinha.querySelectorAll('input, textarea').forEach(el => {
      if (el.type === 'checkbox' || el.type === 'radio') {
        el.checked = false;
      } else {
        el.value = '';
      }
      el.removeAttribute('id');
    });

    tabela.appendChild(novaLinha);

    // Reinicializar Materialize
    setTimeout(() => {
      M.FormSelect.init(document.querySelectorAll('select'));
    }, 0);

    // M.toast({ html: '‚ûï Linha adicionada', classes: 'blue' });
  }

  // FUN√á√ÉO REMOVER LINHA DE MEDICAMENTO
  function removerLinhaMedicamento(botao) {
    const linha = botao.closest('tr');
    const tabela = document.getElementById('tabela-medicamento-body');
    if (tabela.rows.length > 1) {
      linha.remove();
      M.toast({ html: ' Linha removida', classes: 'red' });
    } else {
      M.toast({ html: 'A tabela deve conter pelo menos uma linha.', classes: 'red' });
    }
  }

  // FUN√á√ÉO SALVAR PRESCRI√á√ÉO COM MEDICAMENTOS
  function salvarPrescricaoMedicamentos() {
        setTimeout(() => {
          switchTab('tabObservacoes');
        }, 500);
    }



  // FUN√á√ÉO PARA AVAN√áAR PARA A ABA DE OBSERVA√á√ïES
  function avancarParaObservacoes() {
    // Valida se h√° medicamentos adicionados
    const medicamentos = document.querySelectorAll('select[name="medicamentoNome[]"]');
    let medicamentosPreenchidos = 0;

    medicamentos.forEach((med, index) => {
      const medicamento = med.value;
      const via = document.querySelectorAll('select[name="medicamentoVia[]"]')[index].value;
      const posologia = document.querySelectorAll('input[name="medicamentoPosologia[]"]')[index].value.trim();

      if (medicamento && via && posologia) {
        medicamentosPreenchidos++;
      }
    });

    if (medicamentosPreenchidos === 0) {
      M.toast({ html: '‚ö†Ô∏è Adicione pelo menos um medicamento antes de continuar', classes: 'orange' });
      return;
    }

    // Salva os medicamentos na prescri√ß√£o
    salvarPrescricaoMedicamentos();

    // Avan√ßa para a aba de observa√ß√µes
    switchTab('tabObservacoes');

    // M.toast({ html: '‚úÖ Medicamentos salvos! Agora voc√™ pode adicionar observa√ß√µes finais.', classes: 'green' });
  }

  // FUN√á√ÉO LIMPAR TUDO E VOLTAR PARA ABA INICIAL
  function limparTudoVoltar() {
    // Limpar formul√°rio de dados do paciente
    document.getElementById('formPaciente').reset();
    document.getElementById('promptAdicional').value = '';
    document.getElementById('resultadoIA').innerHTML = '<em>Preencha os dados do paciente e clique em "Analisar"...</em>';
    document.getElementById('prescricaoFinal').value = '';

    // Limpar tabela de medicamentos - manter apenas primeira linha
    const tabela = document.getElementById('tabela-medicamento-body');
    while (tabela.rows.length > 1) {
      tabela.deleteRow(1);
    }

    // Limpar primeira linha
    const primeiraLinha = tabela.rows[0];
    primeiraLinha.querySelectorAll('select').forEach(select => {
      select.value = '';
    });
    primeiraLinha.querySelectorAll('input').forEach(input => {
      input.value = '';
    });

    // Reinicializar selects do Materialize
    M.FormSelect.init(document.querySelectorAll('select'));

    // Remover erros
    document.querySelectorAll('.input-field.error').forEach(el => el.classList.remove('error'));
    document.querySelectorAll('.error-message.show').forEach(el => el.classList.remove('show'));

    M.updateTextFields();

    // Voltar para aba inicial
    switchTab('tabDadosPaciente');

    M.toast({ html: 'üóëÔ∏è Tudo limpo! Voltando para in√≠cio', classes: 'blue-grey' });
  }
</script>

<!-- Arquivo AJAX -->
<script src="{{URL}}/Assets/js/ajax/Xhttp.js"></script>

<script src="{{URL}}/Assets/js/ajax/gerarReceita.js"></script>

<!-- Scripts -->
<script src="http://localhost/MariaProjecto/Assets/js/materialize.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    var elems = document.querySelectorAll('.tooltipped');
    M.Tooltip.init(elems);
  });
</script>
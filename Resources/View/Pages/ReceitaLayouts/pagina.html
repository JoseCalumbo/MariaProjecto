<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel M√©dico com IA</title>

    <link href="{{URL}}/Assets/css/material-icons.css" rel="stylesheet">
    <link href="{{URL}}/Assets/css/boxicons.min.css" rel="stylesheet">

    <link rel="icon" href="{{URL}}/icon.png" type="image/x-icon">

    <!-- Materialize CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet" />

    <link type="text/css" rel="stylesheet" href="{{URL}}/Assets/css/materialize.css" />

    <style>
        body {
            background: #e4e9f7;
            font-family: 'Roboto', sans-serif;
        }

        .font-normal {
            text-transform: none;
        }

        /* drop menu conta activa*/
        .img-conta {
            border-radius: 50%;
            margin-right: 5px;
            position: relative;
            top: 11px;
            color: white;
            cursor: pointer;
            border: 1px solid rgb(255, 248, 248);
        }

        .nav {
            height: 46px;
            line-height: 46px;
            /* Centraliza os itens verticalmente */
        }

        .nav .brand-logo,
        .nav ul li a i {
            height: 46px;
            line-height: 46px;
        }

        .dropdown-content {
            min-width: 220px;
        }

        /* TOP BAR */
        .top-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 45px;
            background: #00695c;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.16);
        }

        .top-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .top-left img {
            height: 28px;
        }

        .online-dot {
            width: 10px;
            height: 10px;
            background: #4caf50;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        /* SIDEBAR CHAT */
        .chat-sidebar {
            position: fixed;
            top: 45px;
            left: 0;
            width: 380px;
            height: calc(100vh - 45px);
            background: #fff;
            z-index: 999;
            transform: translateX(-100%);
            transition: transform .3s ease;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
        }

        .chat-sidebar.open {
            transform: translateX(0);
        }

        .chat-header {
            padding: 12px;
            background: #f5f5f5;
            border-bottom: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-header h6 {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chat-messages {
            flex: 1;
            padding: 15px;
            background: #fafafa;
            overflow-y: auto;
        }

        .chat-input {
            padding: 12px;
            background: #fff;
            border-top: 1px solid #ddd;
            display: flex;
            gap: 8px;
        }

        .chat-input input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        /* FLOAT BUTTON */
        .chat-fab {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: #00695c;
            color: #fff;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, .3);
            cursor: pointer;
            z-index: 1001;
            transition: all .3s ease;
        }

        .chat-fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(0, 0, 0, .4);
        }

        /* MAIN */
        main {
            padding: 60px 20px 20px;
            transition: margin-left .3s ease;
            max-width: 1400px;
            margin-left: auto;
            margin-right: auto;
        }

        .chat-sidebar.open~main {
            margin-left: calc(380px + (100vw - 1400px) / 2);
        }

        @media (max-width: 1400px) {
            .chat-sidebar.open~main {
                margin-left: 380px;
            }
        }

        /* BOX */
        .box {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
        }

        .box h6 {
            margin: 0 0 15px 0;
            font-weight: 500;
            color: #00695c;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* TABS CUSTOMIZADAS */
        .custom-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 0;
            background: transparent;
        }

        .custom-tab {
            flex: 1;
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.7);
            border: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            color: #666;
            font-weight: 500;
            transition: all .3s ease;
            font-size: 14px;
        }

        .custom-tab:hover {
            background: rgba(0, 105, 92, 0.1);
            color: #00695c;
        }

        .custom-tab.active {
            background: #fff;
            color: #00695c;
            box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.08);
        }

        .tab-content-wrapper {
            background: #fff;
            padding: 20px;
            border-radius: 0 8px 8px 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* LOADING SPINNER */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: none;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            z-index: 10;
        }

        .loading-overlay.active {
            display: flex;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #00695c;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* VALIDA√á√ÉO */
        .input-field.error input,
        .input-field.error textarea {
            border-bottom: 1px solid #f44336 !important;
            box-shadow: 0 1px 0 0 #f44336 !important;
        }

        .error-message {
            color: #f44336;
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        /* CHAT MESSAGE */
        .chat-message {
            margin-bottom: 12px;
            padding: 10px;
            border-radius: 8px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chat-message.user {
            background: #e3f2fd;
            text-align: right;
            margin-left: 40px;
        }

        .chat-message.system {
            background: #f5f5f5;
            margin-right: 40px;
        }

        /* RESULTADO IA */
        #resultadoIA {
            line-height: 1.8;
            padding: 10px;
        }

        #resultadoIA em {
            color: #999;
        }

        /* Scrollbar customizada para resultado IA */
        #resultadoIA::-webkit-scrollbar {
            width: 8px;
        }

        #resultadoIA::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        #resultadoIA::-webkit-scrollbar-thumb {
            background: #00695c;
            border-radius: 4px;
        }

        #resultadoIA::-webkit-scrollbar-thumb:hover {
            background: #004d40;
        }

        /* RESPONSIVO */
        @media (max-width: 992px) {
            .chat-sidebar {
                width: 100%;
            }

            .chat-sidebar.open~main {
                margin-left: 0;
            }
        }
    </style>

</head>

<body>

    <!--HEADER-->
    {{header}}

    <!-- CHAT BUTTON -->
    <div class="chat-fab" id="btnOpenChat">
        <i class="material-icons icon-tight" style="font-size: 18px;">chat</i>
    </div>

    <!-- CHAT SIDEBAR -->
    <div class="chat-sidebar" id="chatSidebar">
        <div class="chat-header">
            <h6><i class='bx bx-message-square-dots'></i> Assistente IA</h6>
            <a class="btn-flat" id="btnCloseChat"><i class="material-icons icon-tight"
                    style="font-size: 18px;">close</i></a>
        </div>
        <div class="chat-messages" id="chatMessages">
            <div class="chat-message system">
                <strong>Assistente:</strong> Ol√°! Como posso ajudar com suas d√∫vidas m√©dicas?
            </div>
        </div>
        <div class="chat-input">
            <input type="text" id="chatInput" placeholder="Digite sua mensagem...">
            <a class="btn teal" onclick="sendMsg()">
                <i class="material-icons icon-tight" style="font-size: 18px;">send</i>
            </a>
        </div>
    </div>

    <h5 class="center" style=" margin-left:30px;">Prescri√ß√£o assistida por IA </h5>
    <hr>

    <!-- MAIN CONTENT -->
    <main id="mainContent">

        <!-- LAYOUT HORIZONTAL (LADO A LADO) -->
        <div class="row">

            <!-- PARTE 1: SUGEST√ÉO DA IA (ESQUERDA - 50%) -->
            <div class="col s12 m6 l6">
                <div class="box" style="position: relative; min-height: 250px;">
                    <h6><i class='bx bx-brain'></i> Sugest√£o da IA</h6>
                    <div id="resultadoIA" style="max-height: 500px; overflow-y: auto;">
                        <em>Confirma e preenche os dados do paciente e clique em "Analisar" para receber uma sugest√£o da
                            IA...</em>
                    </div>
                    <div class="loading-overlay" id="loadingIA">
                        <div style="text-align: center;">
                            <div class="spinner"></div>
                            <p style="margin-top:15px;color:#00695c;font-weight:500;">
                                <i class='bx bx-loader-alt bx-spin'></i>A gerar receita aguarde...
                            </p>
                        </div>
                    </div>
                </div>

                <!-- CAMPO DE PROMPT ADICIONAL -->
                <div class="box" style="margin-top: 15px;">
                    <h6><i class='bx bx-message-square-edit'></i> Prompt Adicional</h6>
                    <div class="input-field" style="margin-top: 15px;">
                        <textarea id="promptAdicional" class="materialize-textarea"
                            placeholder="Ex: Considera o hist√≥rico do paciente, ou evitar anti-inflamat√≥rios..."></textarea>
                        <label for="promptAdicional">Instru√ß√µes extras para a IA (opcional)</label>
                    </div>
                    <button type="button" class="btn waves-effect teal font-normal" onclick="refazerAnalise()"
                        id="btnRefazer">
                        <i class='bx bx-refresh'></i> Refazer an√°lise
                    </button>
                </div>
            </div>

            <!-- PARTE 2: TABS (DIREITA - 50%) -->
            <div class="col s12 m6 l6">
                <!-- TABS HEADER -->
                <div class="custom-tabs">
                    <button class="custom-tab active" onclick="switchTab('tabDadosPaciente')" id="btnTabDados">
                        <i class='bx bx-user-circle'></i> Dados do Paciente
                    </button>
                    <button class="custom-tab" onclick="switchTab('tabPrescricaoFinal')" id="btnTabPrescricao">
                        <i class='bx bx-edit'></i> Prescri√ß√£o Final
                    </button>
                </div>

                <!-- TABS CONTENT -->
                <div class="tab-content-wrapper">

                    <!-- TAB 1: DADOS DO PACIENTE -->
                    <div id="tabDadosPaciente" class="tab-panel active">
                        <form id="formPaciente">
                            <div class="row">
                                <div class="input-field col s12 m6">
                                    <input type="text" id="nomePaciente" required>
                                    <label for="nomePaciente">Nome do Paciente *</label>
                                    <span class="error-message" id="errorNome">Campo obrigat√≥rio (m√≠nimo 3
                                        caracteres)</span>
                                </div>
                                <div class="input-field col s12 m3">
                                    <input type="number" id="idadePaciente" min="0" max="150" required>
                                    <label for="idadePaciente">Idade *</label>
                                    <span class="error-message" id="errorIdade">Idade inv√°lida (0-150)</span>
                                </div>
                                <div class="input-field col s12 m3">
                                    <input type="number" id="pesoPaciente" min="1" max="300" step="0.1">
                                    <label for="pesoPaciente">Peso (kg)</label>
                                    <span class="error-message" id="errorPeso">Peso inv√°lido (1-300kg)</span>
                                </div>
                            </div>

                            <div class="row">
                                <div class="input-field col s12">
                                    <textarea id="sintomas" class="materialize-textarea" required></textarea>
                                    <label for="sintomas">Sintomas Relatados *</label>
                                    <span class="error-message" id="errorSintomas">Descreva os sintomas (m√≠nimo 10
                                        caracteres)</span>
                                </div>
                            </div>

                            <div class="row">
                                <div class="input-field col s12 m6">
                                    <textarea id="alergias" class="materialize-textarea"></textarea>
                                    <label for="alergias">Alergias Conhecidas</label>
                                </div>
                                <div class="input-field col s12 m6">
                                    <textarea id="medicamentosUso" class="materialize-textarea"></textarea>
                                    <label for="medicamentosUso">Medicamentos em Uso</label>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col s12">
                                    <button type="button" class="btn green" onclick="gerarPrescricao()"
                                        id="btnAnalisar">
                                        <i class='bx bx-brain'></i> Analisar com IA
                                    </button>
                                    <button type="button" class="btn grey lighten-1" onclick="limparFormulario()">
                                        <i class='bx bx-trash'></i> Limpar
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- TAB 2: PRESCRI√á√ÉO FINAL -->
                    <div id="tabPrescricaoFinal" class="tab-panel">
                        <div class="row">
                            <div class="input-field col s12">
                                <textarea id="prescricaoFinal" class="materialize-textarea"
                                    style="min-height: 250px;"></textarea>
                                <label for="prescricaoFinal">Prescri√ß√£o M√©dica</label>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col s12">
                                <button type="button" class="btn blue" onclick="salvarPrescricao()" id="btnSalvar">
                                    <i class='bx bx-save'></i> Salvar Prescri√ß√£o
                                </button>
                                <button type="button" class="btn teal" onclick="imprimirPrescricao()">
                                    <i class='bx bx-printer'></i> Imprimir
                                </button>
                                <button type="button" class="btn orange" onclick="copiarPrescricao()">
                                    <i class='bx bx-copy'></i> Copiar
                                </button>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

        </div>

    </main>

    <!-- Materialize JS -->
    <script src="{{URL}}/Assets/js/materialize.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

    <script>

        //navbar dropdown do menu dos usuario logado
        document.addEventListener('DOMContentLoaded', function () {
            var drop = document.querySelectorAll('.dropdown-trigger');
            var instances = M.Dropdown.init(drop, {
                coverTrigger: false,
                closeOnClick: false,
                constrainWidth: false,
                alignment: 'left',
                closeOnClick: false // mant√©m aberto enquanto navega

            });
        });

        // Inicializar Materialize
        document.addEventListener('DOMContentLoaded', function () {
            M.updateTextFields();
            M.textareaAutoResize(document.querySelectorAll('.materialize-textarea'));
        });

        // FUN√á√ÉO PARA TROCAR TABS
        function switchTab(tabId) {
            // Remover active de todos os tabs
            document.querySelectorAll('.custom-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            document.querySelectorAll('.tab-panel').forEach(panel => {
                panel.classList.remove('active');
            });

            // Adicionar active no tab clicado
            if (tabId === 'tabDadosPaciente') {
                document.getElementById('btnTabDados').classList.add('active');
            } else {
                document.getElementById('btnTabPrescricao').classList.add('active');
            }

            document.getElementById(tabId).classList.add('active');

            // Atualizar campos do Materialize
            M.updateTextFields();
            M.textareaAutoResize(document.querySelectorAll('.materialize-textarea'));
        }

        // CHAT CONTROLS
        const chatSidebar = document.getElementById('chatSidebar');
        const btnOpen = document.getElementById('btnOpenChat');
        const btnClose = document.getElementById('btnCloseChat');

        btnOpen.onclick = () => {
            chatSidebar.classList.add('open');
            btnOpen.style.display = 'none';
        };

        btnClose.onclick = () => {
            chatSidebar.classList.remove('open');
            btnOpen.style.display = 'flex';
        };

        // VALIDA√á√ïES
        function validarCampo(campo, errorId, validacao) {
            const input = document.getElementById(campo);
            const error = document.getElementById(errorId);
            const inputField = input.closest('.input-field');

            if (!validacao(input.value)) {
                inputField.classList.add('error');
                error.classList.add('show');
                return false;
            } else {
                inputField.classList.remove('error');
                error.classList.remove('show');
                return true;
            }
        }

        function validarFormulario() {
            let valido = true;

            valido &= validarCampo('nomePaciente', 'errorNome', (v) => v.trim().length >= 3);
            valido &= validarCampo('idadePaciente', 'errorIdade', (v) => {
                const idade = parseInt(v);
                return idade >= 0 && idade <= 150;
            });

            const peso = document.getElementById('pesoPaciente').value;
            if (peso) {
                valido &= validarCampo('pesoPaciente', 'errorPeso', (v) => {
                    const p = parseFloat(v);
                    return p > 0 && p <= 300;
                });
            }

            valido &= validarCampo('sintomas', 'errorSintomas', (v) => v.trim().length >= 10);

            return valido;
        }

        // GERAR PRESCRI√á√ÉO COM IA
        async function gerarPrescricao() {
            if (!validarFormulario()) {
                M.toast({ html: '‚ö†Ô∏è Preencha todos os campos obrigat√≥rios corretamente', classes: 'red' });
                return;
            }

            const btnAnalisar = document.getElementById('btnAnalisar');
            btnAnalisar.classList.add('disabled');

            const loading = document.getElementById('loadingIA');
            loading.classList.add('active');

            try {
                // Simular processamento da IA (2-3 segundos)
                await new Promise(resolve => setTimeout(resolve, 2500));

                const nome = document.getElementById('nomePaciente').value;
                const idade = document.getElementById('idadePaciente').value;
                const peso = document.getElementById('pesoPaciente').value;
                const sintomas = document.getElementById('sintomas').value;
                const alergias = document.getElementById('alergias').value;
                const medicamentos = document.getElementById('medicamentosUso').value;
                const promptAdicional = document.getElementById('promptAdicional').value;

                // Resultado da an√°lise da IA
                let resultado = `
          <div style="line-height:1.9;">
            <h6 style="color:#00695c;margin-bottom:15px;">üìã An√°lise Completa</h6>
            
            <p><strong>Paciente:</strong> ${nome}, ${idade} anos${peso ? `, ${peso}kg` : ''}</p>
            
            <p><strong>Sintomas:</strong><br>${sintomas}</p>
            
            ${alergias ? `<p><strong>‚ö†Ô∏è Alergias:</strong> ${alergias}</p>` : ''}
            ${medicamentos ? `<p><strong>üíä Medicamentos em uso:</strong> ${medicamentos}</p>` : ''}
            ${promptAdicional ? `<p><strong>üéØ Considera√ß√µes especiais:</strong><br>${promptAdicional}</p>` : ''}
            
            <hr style="margin:20px 0;border:none;border-top:1px solid #eee;">
            
            <p><strong>üîç Diagn√≥stico Sugerido:</strong><br>
            Quadro viral respirat√≥rio agudo de vias a√©reas superiores</p>
            
            <p><strong>üíä Recomenda√ß√µes Terap√™uticas:</strong></p>
            <ul style="margin-left:20px;">
              <li>Paracetamol 750mg - 1 comprimido de 8/8h por 5 dias</li>
              <li>Dipirona 500mg - 1 comprimido se febre persistente (m√°x 4x/dia)</li>
              <li>Repouso relativo</li>
              <li>Hidrata√ß√£o oral abundante (m√≠nimo 2L/dia)</li>
              <li>Retornar se febre > 3 dias ou piora dos sintomas</li>
            </ul>
            
            <div style="background:#fff3cd;padding:12px;border-radius:6px;margin-top:15px;">
              <small><strong>‚ö†Ô∏è Aten√ß√£o:</strong> Esta √© uma sugest√£o baseada em IA. 
              Revise cuidadosamente antes de prescrever ao paciente.</small>
            </div>
          </div>
        `;

                document.getElementById('resultadoIA').innerHTML = resultado;

                // Preencher prescri√ß√£o final
                const prescricaoTexto = `PRESCRI√á√ÉO M√âDICA

Paciente: ${nome}
Idade: ${idade} anos
Data: ${new Date().toLocaleDateString('pt-BR')}

MEDICAMENTOS:

1) Paracetamol 750mg
   Posologia: 1 comprimido de 8/8 horas
   Dura√ß√£o: 5 dias
   Via: Oral

2) Dipirona 500mg
   Posologia: 1 comprimido se febre persistente
   Frequ√™ncia: M√°ximo 4x ao dia
   Via: Oral

ORIENTA√á√ïES:
- Repouso relativo
- Hidrata√ß√£o oral abundante (m√≠nimo 2 litros/dia)
- Retornar em caso de febre persistente por mais de 3 dias
- Retornar se houver piora dos sintomas

___________________________
Dr. Jos√© Moculo
CRM: XXXXX`;

                document.getElementById('prescricaoFinal').value = prescricaoTexto;
                M.updateTextFields();
                M.textareaAutoResize(document.getElementById('prescricaoFinal'));

                M.toast({ html: '‚úÖ An√°lise conclu√≠da com sucesso!', classes: 'green' });

                // Mudar para a tab de prescri√ß√£o
                setTimeout(() => {
                    switchTab('tabPrescricaoFinal');
                }, 500);

            } catch (error) {
                M.toast({ html: '‚ùå Erro ao gerar prescri√ß√£o', classes: 'red' });
                console.error(error);
            } finally {
                loading.classList.remove('active');
                btnAnalisar.classList.remove('disabled');
            }
        }

        // SALVAR PRESCRI√á√ÉO
        function salvarPrescricao() {
            const prescricao = document.getElementById('prescricaoFinal').value;

            if (!prescricao.trim()) {
                M.toast({ html: '‚ö†Ô∏è Nenhuma prescri√ß√£o para salvar', classes: 'orange' });
                return;
            }

            console.log('Salvando prescri√ß√£o:', prescricao);
            M.toast({ html: 'üíæ Prescri√ß√£o salva com sucesso!', classes: 'green' });
        }

        // IMPRIMIR PRESCRI√á√ÉO
        function imprimirPrescricao() {
            const prescricao = document.getElementById('prescricaoFinal').value;

            if (!prescricao.trim()) {
                M.toast({ html: '‚ö†Ô∏è Nenhuma prescri√ß√£o para imprimir', classes: 'orange' });
                return;
            }

            const printWindow = window.open('', '', 'width=800,height=600');
            printWindow.document.write(`
        <html>
          <head>
            <title>Prescri√ß√£o M√©dica</title>
            <style>
              body { font-family: Arial, sans-serif; padding: 40px; }
              pre { white-space: pre-wrap; font-family: Arial, sans-serif; line-height: 1.6; }
            </style>
          </head>
          <body>
            <pre>${prescricao}</pre>
          </body>
        </html>
      `);
            printWindow.document.close();
            printWindow.print();
        }

        // COPIAR PRESCRI√á√ÉO
        function copiarPrescricao() {
            const prescricao = document.getElementById('prescricaoFinal').value;

            if (!prescricao.trim()) {
                M.toast({ html: '‚ö†Ô∏è Nenhuma prescri√ß√£o para copiar', classes: 'orange' });
                return;
            }

            navigator.clipboard.writeText(prescricao).then(() => {
                M.toast({ html: 'üìã Prescri√ß√£o copiada!', classes: 'green' });
            }).catch(() => {
                M.toast({ html: '‚ùå Erro ao copiar', classes: 'red' });
            });
        }

        // LIMPAR FORMUL√ÅRIO
        function limparFormulario() {
            document.getElementById('formPaciente').reset();
            document.getElementById('resultadoIA').innerHTML = '<em>Preencha os dados do paciente e clique em "Analisar"...</em>';
            document.getElementById('prescricaoFinal').value = '';

            // Remover erros
            document.querySelectorAll('.input-field.error').forEach(el => el.classList.remove('error'));
            document.querySelectorAll('.error-message.show').forEach(el => el.classList.remove('show'));

            M.updateTextFields();
            M.toast({ html: 'üóëÔ∏è Formul√°rio limpo', classes: 'blue-grey' });
        }

        // REFAZER AN√ÅLISE COM PROMPT ADICIONAL
        async function refazerAnalise() {
            const promptAdicional = document.getElementById('promptAdicional').value.trim();

            if (!promptAdicional) {
                M.toast({ html: '‚ö†Ô∏è Digite instru√ß√µes adicionais no campo de prompt', classes: 'orange' });
                return;
            }

            // Verificar se j√° existe uma an√°lise
            const resultadoAtual = document.getElementById('resultadoIA').innerHTML;
            if (resultadoAtual.includes('<em>')) {
                M.toast({ html: '‚ö†Ô∏è Fa√ßa a an√°lise inicial primeiro', classes: 'orange' });
                return;
            }

            const btnRefazer = document.getElementById('btnRefazer');
            btnRefazer.classList.add('disabled');

            const loading = document.getElementById('loadingIA');
            loading.classList.add('active');

            try {
                await new Promise(resolve => setTimeout(resolve, 2000));

                const nome = document.getElementById('nomePaciente').value;
                const idade = document.getElementById('idadePaciente').value;
                const peso = document.getElementById('pesoPaciente').value;

                // An√°lise refinada com prompt adicional
                const resultadoRefinado = `
          <div style="line-height:1.9;">
            <h6 style="color:#00695c;margin-bottom:15px;">üìã An√°lise Refinada</h6>
            
            <p><strong>Paciente:</strong> ${nome}, ${idade} anos${peso ? `, ${peso}kg` : ''}</p>
            
            <div style="background:#e8f5e9;padding:12px;border-radius:6px;margin:15px 0;">
              <strong>üéØ Considera√ß√µes do m√©dico:</strong><br>
              ${promptAdicional}
            </div>
            
            <hr style="margin:20px 0;border:none;border-top:1px solid #eee;">
            
            <p><strong>üîç Diagn√≥stico Ajustado:</strong><br>
            Quadro viral respirat√≥rio agudo - An√°lise ajustada conforme instru√ß√µes m√©dicas</p>
            
            <p><strong>üíä Prescri√ß√£o Personalizada:</strong></p>
            <ul style="margin-left:20px;">
              <li>Paracetamol 500mg - 1 comprimido de 8/8h por 5 dias (ajustado)</li>
              <li>Dipirona 500mg - alternativa se necess√°rio</li>
              <li>Repouso e acompanhamento espec√≠fico conforme orienta√ß√µes</li>
              <li>Hidrata√ß√£o abundante</li>
            </ul>
            
            <div style="background:#fff3cd;padding:12px;border-radius:6px;margin-top:15px;">
              <small><strong>‚úÖ An√°lise refinada:</strong> A IA considerou suas instru√ß√µes adicionais para gerar esta recomenda√ß√£o personalizada.</small>
            </div>
          </div>
        `;

                document.getElementById('resultadoIA').innerHTML = resultadoRefinado;

                // Atualizar prescri√ß√£o
                const prescricaoAtualizada = `PRESCRI√á√ÉO M√âDICA - AN√ÅLISE REFINADA

Paciente: ${nome}
Idade: ${idade} anos
Data: ${new Date().toLocaleDateString('pt-BR')}

CONSIDERA√á√ïES M√âDICAS:
${promptAdicional}

MEDICAMENTOS:

1) Paracetamol 500mg
   Posologia: 1 comprimido de 8/8 horas
   Dura√ß√£o: 5 dias
   Via: Oral

2) Dipirona 500mg (alternativa)
   Posologia: Se necess√°rio
   Via: Oral

ORIENTA√á√ïES:
- Repouso e acompanhamento conforme orienta√ß√µes espec√≠ficas
- Hidrata√ß√£o oral abundante
- Retornar se necess√°rio

___________________________
Dr. Jos√© Moculo
CRM: XXXXX`;

                document.getElementById('prescricaoFinal').value = prescricaoAtualizada;
                M.updateTextFields();
                M.textareaAutoResize(document.getElementById('prescricaoFinal'));

                M.toast({ html: '‚úÖ An√°lise refinada com sucesso!', classes: 'green' });

                setTimeout(() => {
                    switchTab('tabPrescricaoFinal');
                }, 500);

            } catch (error) {
                M.toast({ html: '‚ùå Erro ao refazer an√°lise', classes: 'red' });
                console.error(error);
            } finally {
                loading.classList.remove('active');
                btnRefazer.classList.remove('disabled');
            }
        }

        // CHAT COM VALIDA√á√ÉO
        function sendMsg() {
            const input = document.getElementById('chatInput');
            const mensagem = input.value.trim();

            if (!mensagem) {
                M.toast({ html: '‚ö†Ô∏è Digite uma mensagem', classes: 'orange' });
                return;
            }

            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML += `
        <div class="chat-message user">
          <strong>Voc√™:</strong> ${mensagem}
        </div>
      `;

            input.value = '';
            chatMessages.scrollTop = chatMessages.scrollHeight;

            // Simular resposta da IA
            setTimeout(() => {
                chatMessages.innerHTML += `
          <div class="chat-message system">
            <strong>Assistente:</strong> Entendi sua quest√£o sobre "${mensagem}". 
            Posso ajudar com informa√ß√µes m√©dicas gerais, dosagens e intera√ß√µes medicamentosas.
          </div>
        `;
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 1000);
        }

        // Enter no chat
        document.getElementById('chatInput').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                sendMsg();
            }
        });
    </script>

</body>

</html>